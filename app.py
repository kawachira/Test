import streamlit as st
import yfinance as yf
import pandas as pd
import pandas_ta as ta
import time
import random  # <--- ‡πÄ‡∏û‡∏¥‡πà‡∏° import random ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ AI

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="AI Stock Master", page_icon="üíé", layout="wide")

# --- 2. CSS ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ---
st.markdown("""
    <style>
    /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
    .block-container {
        padding-top: 1rem !important;
        padding-bottom: 0rem !important;
    }

    /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Scroll) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
    div[data-testid="stAppViewContainer"] {
        overflow: hidden !important;
    }

    /* ‡∏à‡∏±‡∏î Title ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    h1 {
        text-align: center;
        font-size: 2.8rem !important;
        margin-bottom: 10px;
    }
    
    /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà */
    div[data-testid="stForm"] {
        border: none;
        padding: 30px;
        border-radius: 20px;
        background-color: var(--secondary-background-color);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        max-width: 800px;
        margin: 0 auto;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà */
    div[data-testid="stFormSubmitButton"] button {
        width: 100%;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 15px 0;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô Metric ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
    div[data-testid="metric-container"] label { font-size: 1.1rem; }
    div[data-testid="metric-container"] div[data-testid="stMetricValue"] { font-size: 1.8rem; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
st.markdown("<h1>üíé Ai<br><span style='font-size: 1.5rem; opacity: 0.7;'>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</span></h1>", unsafe_allow_html=True)

st.write("") # ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á)
col_space1, col_form, col_space2 = st.columns([1, 2, 1])

with col_form:
    with st.form(key='search_form'):
        st.markdown("### üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£")
        c1, c2 = st.columns([3, 1])
        with c1:
            symbol_input = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô AMZN,GOOGL,RKLB, TSLA):", value="EOSE").upper().strip()
        with c2:
            timeframe = st.selectbox("Timeframe:", ["1h (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)", "1d (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)", "1wk (‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)"], index=1)
            
            # Logic ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô code ‡∏ó‡∏µ‡πà yfinance ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
            if "1wk" in timeframe: tf_code = "1wk"
            elif "1h" in timeframe: tf_code = "1h"
            else: tf_code = "1d"
        
        realtime_mode = st.checkbox("üî¥ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Real-time (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥)", value=False)
        submit_btn = st.form_submit_button("üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ & Helper Functions ---

def arrow_html(change):
    if change is None: return ""
    if change > 0:
        return "<span style='color:#16a34a;font-weight:600'>‚ñ≤</span>"  # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    elif change < 0:
        return "<span style='color:#dc2626;font-weight:600'>‚ñº</span>"  # ‡πÅ‡∏î‡∏á
    else:
        return "<span style='color:gray'>‚Äî</span>"

def get_rsi_interpretation(rsi):
    if rsi >= 80: return "üî¥ **Extreme Overbought (80+):** ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡πà‡∏á ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Ç‡∏≤‡∏¢‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏•‡πà‡∏£‡∏≤‡∏Ñ‡∏≤)"
    elif rsi >= 70: return "üü† **Overbought (70-80):** ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á‡∏ï‡∏±‡∏ß ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Ç‡∏≤‡∏¢‡∏û‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ"
    elif rsi >= 55: return "üü¢ **Bullish Zone (55-70):** ‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏•‡∏≤‡∏î ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á"
    elif rsi >= 45: return "‚ö™ **Sideway/Neutral (45-55):** ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Å‡πâ‡∏≥‡∏Å‡∏∂‡πà‡∏á ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"
    elif rsi >= 30: return "üü† **Bearish Zone (30-45):** ‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏´‡∏°‡∏µ‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏•‡∏≤‡∏î ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏´‡∏•‡∏•‡∏á‡∏ï‡πà‡∏≠"
    elif rsi > 20: return "üü¢ **Oversold (20-30):** ‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ç‡∏ï '‡∏Ç‡∏≠‡∏á‡∏ñ‡∏π‡∏Å' ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏£‡∏µ‡∏ö‡∏≤‡∏ß‡∏î‡πå"
    else: return "üü¢ **Extreme Oversold (<20):** ‡∏•‡∏á‡∏•‡∏∂‡∏Å‡∏°‡∏≤‡∏Å Panic Sell ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏ß‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ"

def get_pe_interpretation(pe):
    if isinstance(pe, str) and pe == 'N/A': return "‚ö™ **N/A:** ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)"
    if pe < 0: return "üî¥ **‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (Negative P/E):** ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡πÑ‡∏£"
    if pe < 15: return "üü¢ **‡∏´‡∏∏‡πâ‡∏ô‡∏ñ‡∏π‡∏Å (Low P/E):** ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£ (Value Stock) ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏•‡∏≤‡∏î‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ï‡πà‡∏≥"
    if pe < 30: return "üü° **‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (Average P/E):** ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥"
    return "üü† **‡∏´‡∏∏‡πâ‡∏ô‡πÅ‡∏û‡∏á (High P/E):** ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏•‡∏≤‡∏î‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (Growth Stock)"

# --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Cache) ---
@st.cache_data(ttl=5, show_spinner=False)
def get_data(symbol, interval):
    try:
        ticker = yf.Ticker(symbol)
        
        if interval == "1h": period_val = "730d"
        else: period_val = "10y"
            
        df = ticker.history(period=period_val, interval=interval)
        
        stock_info = {
            'longName': ticker.info.get('longName', symbol),
            'trailingPE': ticker.info.get('trailingPE', 'N/A'),
            
            'regularMarketPrice': ticker.info.get('regularMarketPrice'),
            'regularMarketChange': ticker.info.get('regularMarketChange'),
            'regularMarketChangePercent': ticker.info.get('regularMarketChangePercent'),

            'preMarketPrice': ticker.info.get('preMarketPrice'),
            'preMarketChange': ticker.info.get('preMarketChange'),
            'preMarketChangePercent': ticker.info.get('preMarketChangePercent'),

            'postMarketPrice': ticker.info.get('postMarketPrice'),
            'postMarketChange': ticker.info.get('postMarketChange'),
            'postMarketChangePercent': ticker.info.get('postMarketChangePercent'),
        }
        
        if stock_info['regularMarketPrice'] is None and not df.empty:
             stock_info['regularMarketPrice'] = df['Close'].iloc[-1]
             stock_info['regularMarketChange'] = df['Close'].iloc[-1] - df['Close'].iloc[-2]
             stock_info['regularMarketChangePercent'] = (stock_info['regularMarketChange'] / df['Close'].iloc[-2])

        return df, stock_info
    except:
        return None, None

# --- 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏≠‡∏á AI (‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢) ---
def analyze_market_structure(price, ema20, ema50, ema200, rsi):
    report = {
        "technical": {},
        "context": "",
